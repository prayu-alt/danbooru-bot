"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const node_fetch_1=__importDefault(require("node-fetch")),Constants_1=require("../Constants"),Utils_1=require("../Utils"),Post_1=__importDefault(require("../structures/Post")),SearchResults_1=__importDefault(require("../structures/SearchResults"));class Booru{constructor(t,s=null){const e=Utils_1.resolveSite(t.domain);if(null===e)throw new Error(`Invalid site passed: ${t}`);this.domain=e,this.site=t,this.credentials=s}async search(t,{limit:s=1,random:e=!1,page:r=0}={}){const i=e&&!this.site.random?100:0;try{const o=await this.doSearchRequest(t,{limit:s,random:e,page:r});return this.parseSearchResult(o,{fakeLimit:i,tags:t,limit:s,random:e,page:r})}catch(t){throw new Constants_1.BooruError(t)}}postView(t){if("string"==typeof t&&Number.isNaN(parseInt(t,10)))throw new Constants_1.BooruError(`Not a valid id for postView: ${t}`);return`http${this.site.insecure?"":"s"}://${this.domain}${this.site.api.postView}${t}`}async doSearchRequest(t,{uri:s=null,limit:e=1,random:r=!1,page:i=0}={}){let o;Array.isArray(t)||(t=[t]),r&&(this.site.random?t.push("order:random"):o=100),this.site.defaultTags&&(t=t.concat(this.site.defaultTags.filter(s=>!t.includes(s))));const a=s||Constants_1.searchURI(this.site,t,o||e,i),n=Constants_1.defaultOptions,u="xml"===this.site.type;try{const t=await node_fetch_1.default(a,n),s=u?await t.text():await t.json(),e=u?await Utils_1.jsonfy(s):s;if(t.ok)return e;throw new Constants_1.BooruError(`Received HTTP ${t.status} `+`from booru: '${e.error||e.message||JSON.stringify(e)}'`)}catch(t){if("invalid-json"===t.type)return"";throw t}}parseSearchResult(t,{fakeLimit:s,tags:e,limit:r,random:i,page:o}){if(!1===t.success)throw new Constants_1.BooruError(t.message||t.reason);let a;t.posts&&(t=t.posts),t.images&&(t=t.images),""===t?a=[]:s?a=Utils_1.shuffle(t):t.constructor===Object&&(a=[t]);const n=(a||t).slice(0,r).map(t=>new Post_1.default(t,this)),u={limit:r,random:i,page:o};return void 0===e&&(e=[]),Array.isArray(e)||(e=[e]),new SearchResults_1.default(n,e,u,this)}}exports.Booru=Booru,exports.default=Booru;